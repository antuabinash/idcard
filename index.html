<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Card Data Entry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        h1, h3 {
            text-align: center;
        }
        h1 { color: #0056b3; }
        
        #schoolSetupSection, #entryForm, #shareSection {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        #schoolInfoDisplay {
            max-width: 600px;
            margin: -10px auto 15px auto;
            padding: 10px 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            color: #495057;
        }
        #schoolInfoDisplay p {
            margin: 5px 0;
        }
        
        div {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input[type="text"],
        input[type="date"],
        input[type="tel"],
        input[type="file"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; 
            background-color: #fff;
        }
        ::placeholder {
            color: #aaa;
            opacity: 1; /* Firefox */
        }
        
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Button Colors */
        #saveSetupBtn, #addBtn {
            background-color: #007bff;
            color: white;
        }
        #completeBtn { /* "Submit" */
            background-color: #ffc107;
            color: #333;
        }
        #exportBtn {
            background-color: #28a745;
            color: white;
        }
        #editBtn { /* "Edit" Button */
            background-color: #6c757d;
            color: white;
            margin-top: 0;
        }

        /* --- NEW: Student List Styling --- */
        #studentList {
            max-width: 600px;
            margin: 20px auto 0 auto;
        }
        #studentList div {
            background: #fff;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 5px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center; /* Vertically center items */
        }
        /* New class for the photo in the list */
        .list-preview-img {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            margin-right: 15px;
            flex-shrink: 0;
        }
        /* New class to hold student text info */
        .student-info {
            flex-grow: 1; /* Take up available space */
            display: flex;
            flex-direction: column;
            font-size: 14px;
        }
        .student-sub-details {
            font-size: 12px;
            color: #555;
            margin-top: 2px;
        }
        
        .deleteBtn {
            background-color: #dc3545;
            color: white;
            padding: 5px 8px;
            font-size: 12px;
            border-radius: 4px;
            margin-left: 10px;
            width: auto;
            margin-top: 0;
            flex-shrink: 0;
        }
        /* NEW: Hides delete button when in Step 3 */
        #studentList.step-3-preview .deleteBtn {
            display: none;
        }
        
        /* Photo Preview in Form */
        #photoPreview {
            width: 100px;
            height: 100px;
            display: none;
            margin-top: 10px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

    <h1 id="mainTitle">ID Card Data Entry</h1>

    <div id="schoolSetupSection">
        <h3>Step 1: School Details</h3>
        <div>
            <label for="schoolName">School Name:</label>
            <input type="text" id="schoolName" placeholder="ବିଦ୍ୟାଳୟର ନାମ" required>
        </div>
        <div>
            <label for="district">District (ଜିଲ୍ଲା):</label>
            <select id="districtSelect" required>
                <option value="">ଜିଲ୍ଲା ବାଛନ୍ତୁ</option>
            </select>
        </div>
        <div>
            <label for="block">Block (ବ୍ଲକ):</label>
            <select id="blockSelect" required>
                <option value="">ପ୍ରଥମେ ଜିଲ୍ଲା ବାଛନ୍ତୁ</option>
            </select>
        </div>
        <div>
            <label for="pincode">Pincode:</label>
            <input type="text" id="pincode" placeholder="ପିନକୋଡ୍">
        </div>
        <div>
            <label for="udise">UDISE Code:</label>
            <input type="text" id="udise" placeholder="UDISE କୋଡ୍" required>
        </div>
        <div>
            <label for="hmSignature">HM Signature Photo:</label>
            <input type="file" id="hmSignature" accept="image/png, image/jpeg" required>
        </div>
        <button id="saveSetupBtn">Save & Add Students</button>
    </div>

    <div id="schoolInfoDisplay" style="display:none;"></div>
    
    <div id="entryForm" style="display:none;">
        <h3>Step 2: Add Students</h3>
        <div>
            <label for="name">Full Name:</label>
            <input type="text" id="name" placeholder="ପୂରା ନାମ" required>
        </div>
        <div>
            <label for="class">Class (ଶ୍ରେଣୀ):</label>
            <select id="class" required>
                <option value="">ଶ୍ରେଣୀ ବାଛନ୍ତୁ</option>
                <option value="୦">୦</option>
                <option value="୧">୧</option>
                <option value="୨">୨</option>
                <option value="୩">୩</option>
                <option value="୪">୪</option>
                <option value="୫">୫</option>
                <option value="୬">୬</option>
                <option value="୭">୭</option>
                <option value="୮">୮</option>
                <option value="୯">୯</option>
                <option value="୧୦">୧୦</option>
            </select>
        </div>
        <div>
            <label for="roll">Roll No (ରୋଲ୍ ନମ୍ବର):</label>
            <input type="text" id="roll" placeholder="ରୋଲ୍ ନମ୍ବର" required>
        </div>
        <div>
            <label for="dob">Date of Birth:</label>
            <input type="date" id="dob">
        </div>
        <div>
            <label for="phone">Phone No:</label>
            <input type="text" id="phone" placeholder="ଫୋନ୍ ନମ୍ବର">
        </div>
        <div>
            <label for="photo">Student Photo:</label>
            <input type="file" id="photo" accept="image/png, image/jpeg">
            <img id="photoPreview" src="" alt="Student Preview">
        </div>
        
        <button id="addBtn">Add Student</button>
        <button id="completeBtn" disabled>Submit</button> 
    </div>

    <h3 id="previewTitle" style="display:none;">Student Preview:</h3>
    <div id="studentList">
        </div>

    <div id="shareSection" style="display:none;">
        <h3>Step 3: Export Data</h3>
        <button id="exportBtn">Download / Share All Data</button>
        <button id="editBtn">Edit</button>
    </div>

    <script>
        // --- ODIA DATA (Districts & Blocks) ---
        const odishaData = {
            "ଅନୁଗୁଳ": ["ଅନୁଗୁଳ", "ଆଠମଲ୍ଲିକ", "ଛେଣ୍ଡିପଦା", "ତାଳଚେର", "ପାଲଲହଡ଼ା", "ବଅଁରପାଳ", "କିଶୋରନଗର", "କଣିହାଁ"],
            "ବଲାଙ୍ଗୀର": ["ଆଗଲପୁର", "ବଲାଙ୍ଗୀର", "ବେଲପଡ଼ା", "ବଙ୍ଗୋମୁଣ୍ଡା", "ଦେଓଗାଁ", "ଗୁଡଭେଲା", "ଖପ୍ରାଖୋଲ", "ଲୋଇସିଂହା", "ମୁରିବାହାଲ", "ପାଟଣାଗଡ଼", "ପୁଇଁତଳା", "ସଇଁତଳା", "ଟିଟିଲାଗଡ଼", "ତୁରେକେଲା"],
            "ବରଗଡ଼": ["ଅତାବିରା", "ଅମ୍ବାଭୋନା", "ବରଗଡ଼", "ବରପାଲି", "ଭେଡେନ", "ଭଟଲି", "ବିଜେପୁର", "ଗାଇସିଲେଟ", "ଝାରବନ୍ଧ", "ପଦ୍ମପୁର", "ପାଇକମାଳ", "ସୋହେଲା"],
            "ଭଦ୍ରକ": ["ବାସୁଦେବପୁର", "ଭଦ୍ରକ", "ଭଣ୍ଡାରିପୋଖରୀ", "ଚାନ୍ଦବାଲି", "ଧାମନଗର", "ତିହିଡ଼ି", "ବନ୍ତ"],
            "ବାଲେଶ୍ୱର": ["ବାହାନଗା", "ବାଲେଶ୍ୱର", "ବାଲିଆପାଳ", "ବସ୍ତା", "ଭୋଗରାଇ", "ଜଳେଶ୍ୱର", "ଖଇରା", "ନୀଳଗିରି", "ଔପଦା", "ରେମୁଣା", "ସିମୁଳିଆ", "ସୋର"],
            "କଟକ": ["ଆଠଗଡ଼", "ବାଙ୍କୀ", "ଡମପଡ଼ା", "ବାରଙ୍ଗ", "କଟକ ସଦର", "କଣ୍ଟାପଡ଼ା", "ମାହାଙ୍ଗା", "ନରସିଂହପୁର", "ନିଆଳି", "ନିଶ୍ଚିନ୍ତକୋଇଲି", "ସାଲେପୁର", "ଟାଙ୍ଗୀ-ଚୌଦ୍ୱାର", "ତିଗିରିଆ", "ବଡ଼ମ୍ବା"],
            "ଦେବଗଡ଼": ["ବାରକୋଟ", "ଦେବଗଡ଼", "ରିଆମାଳ", "ତିଲେଇବଣି"],
            "ଢେଙ୍କାନାଳ": ["ଭୁବନ", "ଢେଙ୍କାନାଳ ସଦର", "ଗଁଦିଆ", "ହିନ୍ଦୋଳ", "କାମାକ୍ଷାନଗର", "କଙ୍କଡ଼ାହାଡ଼", "ଓଡ଼ାପଡ଼ା", "ପରଜଙ୍ଗ"],
            "ଗଜପତି": ["ଗୋଷାଣୀ", "ଗୁମ୍ମା", "କାଶୀନଗର", "ମୋହନା", "ନୂଆଗଡ଼", "ଆର. ଉଦୟଗିରି", "ରାୟଗଡ଼"],
            "ଗଞ୍ଜାମ": ["ଆସ୍କା", "ବେଗୁନିଆପଡ଼ା", "ବେଲଗୁଣ୍ଠା", "ଭଞ୍ଜନଗର", "ବୁଗୁଡ଼ା", "ଛତ୍ରପୁର", "ଚିକିଟି", "ଧରାକୋଟ", "ଦିଗପହଣ୍ଡି", "ଗଞ୍ଜାମ", "ହିଞ୍ଜିଳିକାଟୁ", "ଜଗନ୍ନାଥପ୍ରସାଦ", "ଖଲ୍ଲିକୋଟ", "କୁକୁଡ଼ାଖଣ୍ଡି", "ପାଟପୁର", "ପୋଲସରା", "ପୁରୁଷୋତ୍ତମପୁର", "ରଙ୍ଗେଇଲୁଣ୍ଡା", "ସାନଖେମୁଣ୍ଡି", "ଶେରଗଡ଼", "ସୋରଡ଼ା"],
            "ଜଗତସିଂହପୁର": ["ବାଲିକୁଦା", "ବିରିଡ଼ି", "ଏରସମା", "ଜଗତସିଂହପୁର", "କୁଜଙ୍ଗ", "ନାଉଗାଁ", "ରଘୁନାଥପୁର", "ତିର୍ତ୍ତୋଲ"],
            "ଯାଜପୁର": ["ବଡ଼ଚଣା", "ବରୀ", "ବିଞ୍ଝାରପୁର", "ଦାନଗଦି", "ଦଶରଥପୁର", "ଧର୍ମଶାଳା", "ଯାଜପୁର", "କୋରେଇ", "ରସୁଲପୁର", "ସୁକିନ୍ଦା"],
            "ଝାରସୁଗୁଡ଼ା": ["ଝାରସୁଗୁଡ଼ା", "କିରମିରା", "କୋଲାବିରା", "ଲଇକେରା", "ଲଖନପୁର"],
            "କଳାହାଣ୍ଡି": ["ଭବାନୀପାଟଣା", "ଧର୍ମଗଡ଼", "ଗୋଲାମୁଣ୍ଡା", "ଜୟପାଟଣା", "ଜୁନାଗଡ଼", "କଳମପୁର", "କର୍ଲାମୁଣ୍ଡା", "କେସିଙ୍ଗା", "କୋକସରା", "ଲାଞ୍ଜିଗଡ଼", "ମଦନପୁର-ରାମପୁର", "ନର୍ଲା", "ଥୁଆମୂଳ ରାମପୁର"],
            "କନ୍ଧମାଳ": ["ବାଲିଗୁଡ଼ା", "ଚକାପାଦ", "ଦାରିଙ୍ଗବାଡ଼ି", "ଫୁଲବାଣୀ", "ଘୁ. ଉଦୟଗିରି", "ହରଭଙ୍ଗା", "କ. ନୂଆଗାଁ", "ଖଜୁରୀପଡ଼ା", "କୋଟଗଡ଼", "ଫିରିଙ୍ଗିଆ", "ରାଇକିଆ", "ଟିକାବାଲି"],
            "କେନ୍ଦ୍ରାପଡ଼ା": ["ଆଳି", "ଡେରାବିଶ", "ଗରଦପୁର", "କେନ୍ଦ୍ରାପଡ଼ା", "ମହାକାଳପଡ଼ା", "ମାର୍ଶାଘାଇ", "ପଟ୍ଟାମୁଣ୍ଡାଇ", "ରାଜକନିକା", "ରାଜନଗର"],
            "କେନ୍ଦୁଝର": ["ଆନନ୍ଦପୁର", "ବାଂଶପାଳ", "ଚମ୍ପୁଆ", "ଘଟଗାଁ", "ଘସିପୁରା", "ହରିଚନ୍ଦନପୁର", "ହାଟଡିହି", "ଯୋଡ଼ା", "ଝୁମ୍ପୁରା", "କେନ୍ଦୁଝର ସଦର", "ପାଟଣା", "ସାହାରପଡ଼ା", "ତେଲକୋଇ"],
            "ଖୋର୍ଦ୍ଧା": ["ବାଲିଅନ୍ତା", "ବାଲିପାଟଣା", "ବାଣପୁର", "ବେଗୁନିଆ", "ଭୁବନେଶ୍ୱର", "ବୋଲଗଡ଼", "ଚିଲିକା", "ଜଟଣୀ", "ଖୋର୍ଦ୍ଧା ସଦର", "ଟାଙ୍ଗୀ"],
            "କୋରାପୁଟ": ["ବାନ୍ଧୁଗାଁ", "ବୈପାରିଗୁଡ଼ା", "ବୋରିଗୁମ୍ମା", "ଦଶମନ୍ତପୁର", "ଜୟପୁର", "କୋରାପୁଟ", "କୋଟପାଡ଼", "କୁନ୍ଦୁରା", "ଲାମତାପୁଟ", "ଲକ୍ଷ୍ମୀପୁର", "ମାଛକୁଣ୍ଡ", "ନନ୍ଦପୁର", "ନାରାୟଣପାଟଣା", "ପଟ୍ଟାଙ୍ଗୀ", "ସେମିଳିଗୁଡ଼ା"],
            "ମାଲକାନଗିରି": ["ଚିତ୍ରକୋଣ୍ଡା", "କାଲିମେଳା", "ଖଇରପୁଟ", "କୋରୁକୋଣ୍ଡା", "କୁଡୁମୁଲୁଗୁମ୍ମା", "ମାଲକାନଗିରି", "ମାଥିଲି", "ପଡ଼ିଆ"],
            "ମୟୂରଭଞ୍ଜ": ["ବାଙ୍ଗିରିପୋଷି", "ବାରିପଦା", "ବଡ଼ସାହି", "ବେତନଟୀ", "ବିଶୋଇ", "ବିଜାତଳା", "ଗୋପବନ୍ଧୁନଗର", "ଜାମଦା", "ଯଶୀପୁର", "କପ୍ତିପଦା", "କରଞ୍ଜିଆ", "କୁଳିଅଣା", "କୁସୁମି", "ମୋରଡ଼ା", "ରରୁଆଁ", "ରାସଗୋବିନ୍ଦପୁର", "ରାଇରଙ୍ଗପୁର", "ଶାମାଖୁଣ୍ଟା", "ଶୁକ୍ରୁଳି", "ସୁଳିଆପଦା", "ଠାକୁରମୁଣ୍ଡା", "ତିରିଂ"],
            "ନବରଙ୍ଗପୁର": ["ଚନ୍ଦାହାଣ୍ଡି", "ଡାବୁଗାଁ", "ଝରିଗାଁ", "କୋଷାଗୁମୁଡ଼ା", "ନନ୍ଦାହାଣ୍ଡି", "ନବରଙ୍ଗପୁର", "ପାପଡ଼ାହାଣ୍ଡି", "ରାଇଘର", "ତେନ୍ତୁଳିଖୁଣ୍ଟି", "ଉମରକୋଟ"],
            "ନୟାଗଡ଼": ["ଭାପୁର", "ଦଶପଲ୍ଲା", "ଗଣିଆ", "ଖଣ୍ଡପଡ଼ା", "ନୟାଗଡ଼", "ନୂଆଗାଁ", "ଓଡ଼ଗାଁ", "ରଣପୁର"],
            "ନୂଆପଡ଼ା": ["ବୋଡ଼େନ", "ଯୋଙ୍କ", "ଖଡ଼ିଆଳ", "କୋମନା", "ନୂଆପଡ଼ା", "ସିନାପାଲି"],
            "ପୁରୀ": ["ଅସ୍ତରଙ୍ଗ", "ବ୍ରହ୍ମଗିରି", "ଚନ୍ଦନପୁର", "ଡେଲାଙ୍ଗ", "ଗୋପ", "କାକଟପୁର", "କଣାସ", "କୃଷ୍ଣପ୍ରସାଦ", "ନିମାପଡ଼ା", "ପିପିଲି", "ପୁରୀ ସଦର", "ସତ୍ୟବାଦୀ"],
            "ରାୟଗଡ଼ା": ["ବିଷମକଟକ", "ଚନ୍ଦ୍ରପୁର", "ଗୁଣୁପୁର", "କାଶୀପୁର", "କୋଲନରା", "ମୁନିଗୁଡ଼ା", "ପଦ୍ମପୁର", "ରାମନଗୁଡ଼ା", "ରାୟଗଡ଼ା"],
            "ସମ୍ବଲପୁର": ["ବରମୁରା", "ଧନକଉଡ଼ା", "ଜମନକିରା", "ଯୁଯୁମୁରା", "କୁଚିଣ୍ଡା", "ମାନେଶ୍ୱର", "ନକ୍ଟିଦେଉଳ", "ରେଢ଼ାଖୋଲ", "ରେଙ୍ଗାଲି"],
            "ସୁବର୍ଣ୍ଣପୁର (ସୋନପୁର)": ["ବୀରମହାରାଜପୁର", "ବିନିକା", "ଡୁଙ୍ଗୁରିପାଲି", "ରାମପୁର", "ସୋନପୁର", "ତରଭା", "ଉଲୁଣ୍ଡା"],
            "ସୁନ୍ଦରଗଡ଼": ["ବାଲିଶଙ୍କରା", "ବଡ଼ଗାଁ", "ବିଶ୍ରା", "ବଣାଇ", "ହେମଗିରି", "ଗୁରୁଣ୍ଡିଆ", "କୋଇଡ଼ା", "କୁଆରମୁଣ୍ଡା", "ଲାଠିକଟା", "ଲହୁଣୀପଡ଼ା", "ଲେଫ୍ରିପଡ଼ା", "ନୂଆଗାଁ", "ରାଜଗାଙ୍ଗପୁର", "ସବଡେଗା", "ସୁନ୍ଦରଗଡ଼", "ଟାଙ୍ଗରପାଲି"]
        };
        
        // --- NEW: Odia Date Constants ---
        const odiaDigits = ['୦', '୧', '୨', '୩', '୪', '୫', '୬', '୭', '୮', '୯'];
        const odiaMonths = ['ଜାନୁଆରୀ', 'ଫେବୃଆରୀ', 'ମାର୍ଚ୍ଚ', 'ଅପ୍ରେଲ', 'ମଇ', 'ଜୁନ୍', 'ଜୁଲାଇ', 'ଅଗଷ୍ଟ', 'ସେପ୍ଟେମ୍ବର', 'ଅକ୍ଟୋବର', 'ନଭେମ୍ବର', 'ଡିସେମ୍ବର'];

        let schoolData = {};
        let students = [];

        // --- Get All DOM Elements ---
        const mainTitle = document.getElementById('mainTitle');
        const schoolInfoDisplay = document.getElementById('schoolInfoDisplay');
        const schoolSetupSection = document.getElementById('schoolSetupSection');
        const saveSetupBtn = document.getElementById('saveSetupBtn');
        const schoolNameInput = document.getElementById('schoolName');
        const districtSelect = document.getElementById('districtSelect');
        const blockSelect = document.getElementById('blockSelect');
        const pincodeInput = document.getElementById('pincode');
        const udiseInput = document.getElementById('udise');
        const hmSignatureInput = document.getElementById('hmSignature');
        const entryForm = document.getElementById('entryForm');
        const completeBtn = document.getElementById('completeBtn');
        const addBtn = document.getElementById('addBtn');
        const nameInput = document.getElementById('name');
        const classSelect = document.getElementById('class');
        const rollInput = document.getElementById('roll');
        const dobInput = document.getElementById('dob');
        const phoneInput = document.getElementById('phone');
        const photoInput = document.getElementById('photo');
        const photoPreview = document.getElementById('photoPreview');
        const shareSection = document.getElementById('shareSection');
        const exportBtn = document.getElementById('exportBtn');
        const editBtn = document.getElementById('editBtn'); 
        const studentListDiv = document.getElementById('studentList');
        const previewTitle = document.getElementById('previewTitle');

        // --- PREVENT ACCIDENTAL BACK BUTTON ---
        window.addEventListener('beforeunload', (e) => {
            if (students.length > 0 || schoolNameInput.value) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
        
        // --- NEW: Odia Date Conversion Function ---
        function convertToOdiaDate(dateString) {
            if (!dateString) return '';
            try {
                const [year, month, day] = dateString.split('-');
                if (!year || !month || !day) return '';
                
                const odiaYear = year.split('').map(d => odiaDigits[parseInt(d)]).join('');
                const odiaDay = day.split('').map(d => odiaDigits[parseInt(d)]).join('');
                const odiaMonthName = odiaMonths[parseInt(month) - 1];
                
                return `${odiaDay} ${odiaMonthName} ${odiaYear}`;
            } catch (e) {
                console.error("Could not parse date:", dateString);
                return ''; // Return empty if date is invalid
            }
        }

        // --- 0. POPULATE DISTRICTS & BLOCKS ---
        function populateDistricts() {
            const districts = Object.keys(odishaData);
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
        districtSelect.addEventListener('change', () => {
            const selectedDistrict = districtSelect.value;
            blockSelect.innerHTML = '<option value="">ବ୍ଲକ ବାଛନ୍ତୁ</option>';
            if (selectedDistrict && odishaData[selectedDistrict]) {
                odishaData[selectedDistrict].forEach(block => {
                    const option = document.createElement('option');
                    option.value = block;
                    option.textContent = block;
                    blockSelect.appendChild(option);
                });
            }
        });

        // --- 1. SAVE SCHOOL SETUP ---
        saveSetupBtn.addEventListener('click', () => {
            const signatureFile = hmSignatureInput.files[0];
            if (!schoolNameInput.value || !districtSelect.value || !blockSelect.value || !udiseInput.value || !signatureFile) {
                alert('Please fill in all School Name, District, Block, UDISE Code, and upload a Signature.');
                return;
            }
            schoolData = {
                schoolName: schoolNameInput.value,
                block: blockSelect.value,
                district: districtSelect.value,
                pincode: pincodeInput.value,
                udise: udiseInput.value,
                signatureFile: signatureFile,
                signatureFileName: signatureFile.name
            };
            schoolInfoDisplay.innerHTML = `
                <p><strong>School:</strong> ${schoolData.schoolName}</p>
                <p><strong>UDISE:</strong> ${schoolData.udise}</p>
                <p><strong>Block:</strong> ${schoolData.block}, <strong>District:</strong> ${schoolData.district}</p>
            `;
            schoolInfoDisplay.style.display = 'block';
            schoolSetupSection.style.display = 'none';
            entryForm.style.display = 'block';
            mainTitle.textContent = schoolData.schoolName;
        });

        // --- 2. ADD STUDENT (Modified with FileReader) ---
        addBtn.addEventListener('click', () => {
            const classVal = classSelect.value.trim();
            const rollVal = rollInput.value.trim();
            const originalPhoto = photoInput.files[0];
            const nameVal = nameInput.value.trim();
            const dobVal = dobInput.value; // Get DOB

            if (!nameVal || !classVal || !rollVal) {
                alert('Please fill in at least Name, Class, and Roll No.');
                return;
            }
            if (!originalPhoto) {
                alert('Please upload a photo for the student.');
                return;
            }
            
            // --- Use FileReader to get Data URL for preview ---
            const reader = new FileReader();
            reader.onload = (e) => {
                const photoDataUrl = e.target.result; // This is the base64 string
                const odiaDOB = convertToOdiaDate(dobVal); // Convert DOB
                
                const firstName = nameVal.split(' ')[0] || 'student';
                const safeFirstName = firstName.replace(/[^a-zA-Z0-9]/g, '');
                const extension = originalPhoto.name.split('.').pop().toLowerCase();
                const newFilename = `${safeFirstName}_${rollVal}.${extension}`;
                
                const studentId = Date.now();
                const student = {
                    id: studentId,
                    name: nameVal,
                    class: classVal,
                    dob: dobVal,
                    dobOdia: odiaDOB, // Store Odia DOB
                    roll: rollVal,
                    phone: phoneInput.value,
                    photoFile: originalPhoto,
                    photoDataUrl: photoDataUrl, // Store photo preview data
                    newPhotoName: newFilename
                };
                students.push(student);
                
                // --- NEW: Updated student list item HTML ---
                const studentDiv = document.createElement('div');
                studentDiv.dataset.studentId = studentId;
                studentDiv.innerHTML = `
                    <img src="${student.photoDataUrl}" class="list-preview-img" alt="Photo">
                    <div class="student-info">
                        <span class="student-main-details"><strong>${student.name}</strong> (Class: ${student.class}, Roll: ${student.roll})</span>
                        <span class="student-sub-details">DOB: ${student.dobOdia || 'N/A'}</span>
                    </div>
                    <button class="deleteBtn" data-id="${studentId}">Delete</button>
                `;
                studentListDiv.appendChild(studentDiv);
                
                // Clear form
                nameInput.value = '';
                classSelect.value = '';
                rollInput.value = '';
                dobInput.value = '';
                phoneInput.value = '';
                photoInput.value = '';
                photoPreview.src = '';
                photoPreview.style.display = 'none';
                nameInput.focus();
                
                completeBtn.disabled = false;
            };
            
            // Read the image file as a Data URL
            reader.readAsDataURL(originalPhoto);
        });
        
        // --- STUDENT PHOTO PREVIEW (in form) ---
        photoInput.addEventListener('change', () => {
            const file = photoInput.files[0];
            if (file) {
                photoPreview.src = URL.createObjectURL(file);
                photoPreview.style.display = 'block';
            } else {
                photoPreview.src = '';
                photoPreview.style.display = 'none';
            }
        });

        // --- 2b. DELETE STUDENT ---
        studentListDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('deleteBtn')) {
                const studentId = e.target.dataset.id;
                students = students.filter(s => s.id.toString() !== studentId);
                e.target.closest('div[data-student-id]').remove();
                
                if (students.length === 0) {
                    completeBtn.disabled = true;
                }
            }
        });

        // --- 3. COMPLETE ADDING (Show Export Button) ---
        completeBtn.addEventListener('click', () => {
            if (students.length === 0) return;
            
            entryForm.style.display = 'none';
            previewTitle.style.display = 'block';
            studentListDiv.style.display = 'block';
            shareSection.style.display = 'block';
            schoolInfoDisplay.style.display = 'none';
            
            // --- NEW: Add class to hide delete buttons ---
            studentListDiv.classList.add('step-3-preview');
        });

        // --- 3b. EDIT BUTTON (Go back to Step 2) ---
        editBtn.addEventListener('click', () => {
            shareSection.style.display = 'none';
            previewTitle.style.display = 'none';
            entryForm.style.display = 'block';
            schoolInfoDisplay.style.display = 'block';
            
            // --- NEW: Remove class to show delete buttons ---
            studentListDiv.classList.remove('step-3-preview');
        });

        // --- 4. EXPORT "SMART" FUNCTION ---
        exportBtn.addEventListener('click', async () => {
            if (students.length === 0) return;

            exportBtn.textContent = 'Processing... Please Wait...';
            exportBtn.disabled = true;
            let zipBlob;
            const zipFileName = 'student_id_data.zip';

            try {
                // CSV generation
                const headers = [
                    'Name', 'Class', 'DOB', 'RollNo', 'Phone', 'PhotoPath',
                    'SchoolName', 'Block', 'District', 'Pincode', 'UDISE', 'SignatureFile'
                ];
                let csvContent = headers.join(',') + '\n';
                students.forEach(student => {
                    const photoPath = `e:\\photos\\${schoolData.udise}\\${student.newPhotoName}`;
                    const row = [
                        `"${student.name}"`,
                        `"${student.class}"`,
                        `"${student.dob}"`,
                        `"${student.roll}"`,
                        `"${student.phone}"`,
                        `"${photoPath}"`,
                        `"${schoolData.schoolName}"`,
                        `"${schoolData.block}"`,
                        `"${schoolData.district}"`,
                        `"${schoolData.pincode}"`,
                        `"${schoolData.udise}"`,
                        `"${schoolData.signatureFileName}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                // Zip creation
                const zip = new JSZip();
                zip.file('student_data.csv', csvContent);
                zip.file(schoolData.signatureFileName, schoolData.signatureFile);
                students.forEach(student => {
                    zip.file(student.newPhotoName, student.photoFile);
                });
                zipBlob = await zip.generateAsync({ type: 'blob' });
                
                const zipFile = new File([zipBlob], zipFileName, {
                    type: 'application/zip',
                    lastModified: new Date().getTime()
                });
                const shareData = {
                    title: 'Student ID Data',
                    text: 'Student CSV and photos for ID card generation.',
                    files: [zipFile]
                };

                // Share or Download
                if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                } else {
                    downloadBlob(zipBlob, zipFileName, 'application/zip');
                }
            } catch (err) {
                console.error('Error sharing zip file:', err);
                if (err.name !== 'AbortError') {
                    if (zipBlob) {
                        downloadBlob(zipBlob, zipFileName, 'application/zip');
                    } else {
                        alert('A critical error occurred while creating the zip file.');
                    }
                }
            } finally {
                exportBtn.textContent = 'Download / Share All Data';
                exportBtn.disabled = false;
            }
        });

        // --- 5. Helper function to trigger download ---
        function downloadBlob(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- 6. Initialize District Dropdown ---
        populateDistricts();

    </script>

</body>
</html>
